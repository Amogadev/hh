/**
 * @file firestore.rules
 * @description Firestore Security Rules for the Hotel Management application.
 *
 * @section Core Philosophy
 * This ruleset implements a public, read-only data model for hotel and room data,
 * while providing user-specific write access for enquiries.
 *
 * @section Data Structure
 * - /hotels/{hotelId}: Publicly readable hotel data.
 * - /hotels/{hotelId}/rooms/{roomId}: Publicly readable room data.
 * - /enquiries/{enquiryId}: User-specific enquiry data.
 *
 * @section Key Security Decisions
 * - Public Read Access (Hotels/Rooms): Hotel and room data is public to read.
 *   All write operations are disabled and should be handled by a trusted backend.
 * - User-Owned Enquiries: Authenticated users can create, read, update, and
 *   delete their own enquiry documents. They cannot access enquiries from others.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the request is from an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * A declarative helper that explicitly signifies a collection is public.
     * Always returns true.
     */
    function isPublic() {
      return true;
    }

    /**
     * A declarative helper that explicitly disables all client-side writes.
     * Always returns false.
     */
    function clientWritesDisabled() {
      return false;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to Hotel documents.
     */
    match /hotels/{hotelId} {
      allow get: if isPublic();
      allow list: if isPublic();
      allow write: if clientWritesDisabled();

      /**
       * @description Controls access to Room subcollections.
       */
      match /rooms/{roomId} {
        allow get: if isPublic();
        allow list: if isPublic();
        allow write: if true; // Managed by client logic

        /**
         * @description Controls access to Payment subcollections.
         */
        match /payments/{paymentId} {
          allow get: if isPublic();
          allow list: if isPublic();
          allow write: if true; // Managed by client logic
        }
      }
    }

    /**
     * @description Controls access to Enquiry documents.
     * Users can manage their own enquiries.
     * @path /enquiries/{enquiryId}
     * @allow (read, update, delete) if the user is the owner of the document.
     * @allow (create) if the user is signed in and the new document's userId matches their own.
     * @allow (list) if the query is limited to the user's own documents.
     */
    match /enquiries/{enquiryId} {
      allow read, update, delete: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      allow list: if isSignedIn() && request.query.where.userId == request.auth.uid;
    }
  }
}
    